<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mdraft - Document to Markdown Converter</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <style>
        :root {
            --primary-start: #2563eb;
            --primary-end: #7c3aed;
            --background: #f8f9fa;
            --surface: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--background); min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .header { width: 100%; background: var(--surface); padding: 15px 40px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dee2e6; }
        .header .brand { font-size: 1.5em; font-weight: 700; color: var(--text-primary); text-decoration: none; }
        
        /* Logo styling */
        .header .brand img {
            height: 96px; /* Increased from 80px by 20% */
            width: auto;
            display: block;
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .header {
                padding: 10px 20px;
                flex-direction: column;
                gap: 15px;
            }
            
            .header .brand img {
                height: 60px; /* Smaller on mobile */
            }
            
            .header .nav-links {
                gap: 10px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .container {
                padding: 20px;
                margin-top: 20px;
            }
            
            .welcome-message {
                padding: 40px 20px;
            }
            
            .welcome-message h1 {
                font-size: 2em;
                line-height: 1.2;
            }
            
            .welcome-message p {
                font-size: 1em;
            }
            
            .welcome-message .btn {
                font-size: 1em;
                padding: 12px 20px;
                white-space: nowrap; /* Prevent button text wrapping */
                width: auto;
                min-width: 200px;
            }
            
            .welcome-btn {
                font-size: 1em;
                padding: 12px 20px;
                white-space: nowrap;
                min-width: 200px;
            }
            
            .upload-section {
                padding: 20px;
            }
            
            .file-input {
                padding: 30px 15px;
            }
            
            .convert-btn {
                font-size: 14px;
                padding: 12px;
            }
        }
        
        /* Extra small mobile devices */
        @media (max-width: 480px) {
            .header .brand img {
                height: 50px;
            }
            
            .welcome-message h1 {
                font-size: 1.8em;
            }
            
            .welcome-message .btn {
                min-width: 180px;
                font-size: 0.9em;
            }
        }
        .header .nav-links { display: flex; align-items: center; gap: 20px; }
        .header .nav-links a { text-decoration: none; color: var(--text-secondary); font-weight: 500; transition: color 0.2s; cursor: pointer; padding: 5px 10px; border-radius: 4px; }
        .header .nav-links a:hover { color: var(--primary-start); text-decoration: underline; }
        .header .nav-links .btn { background: var(--primary-start); color: white; padding: 8px 15px; border-radius: 8px; transition: background 0.2s; }
        .header .nav-links .btn:hover { background: var(--primary-end); }
        .container { width: 100%; max-width: 800px; padding: 40px; margin-top: 40px; }
        .welcome-message { text-align: center; padding: 60px 40px; background-color: var(--surface); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .welcome-message h1 { font-size: 2.5em; font-weight: 700; margin-bottom: 15px; }
        .welcome-message p { font-size: 1.1em; color: var(--text-secondary); margin-bottom: 30px; }
        .welcome-message .btn { font-size: 1.1em; padding: 12px 25px; }
        
        .welcome-btn {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            color: white;
            text-decoration: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;
            min-width: 200px;
        }
        
        .welcome-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            color: white;
            text-decoration: none;
        }
        .upload-section { background: var(--surface); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .file-input-wrapper { position: relative; display: block; width: 100%; margin-bottom: 20px; }
        .file-input { width: 100%; padding: 40px 20px; border: 2px dashed #dee2e6; border-radius: 12px; background: #f8f9fa; cursor: pointer; text-align: center; transition: all 0.3s ease; }
        .file-input:hover { border-color: var(--primary-start); background: #e9ecef; }
        .file-input input[type="file"] { position: absolute; opacity: 0; width: 100%; height: 100%; top: 0; left: 0; cursor: pointer; }
        .convert-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; }
        .convert-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); }
        .convert-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .loading { display: none; text-align: center; margin: 20px 0; color: var(--primary-start); }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-start); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .result-section { display: none; margin-top: 30px; background: var(--surface); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .result-title { font-size: 1.2em; font-weight: 600; color: var(--text-primary); }
        .action-buttons { display: flex; gap: 10px; }
        .action-btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; }
        .copy-btn { background: #28a745; color: white; }
        .copy-btn:hover { background: #218838; }
        .download-btn { background: #007bff; color: white; text-decoration: none; display: none; }
        .download-btn:hover { background: #0056b3; }
        .pro-download-btn { background: #28a745; color: white; text-decoration: none; display: none; margin-left: 8px; }
        .pro-download-btn:hover { background: #218838; }
        .markdown-output { width: 100%; min-height: 300px; padding: 20px; border: 1px solid #dee2e6; border-radius: 12px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6; background: #f8f9fa; resize: vertical; }
        .error-message, .success-message { padding: 15px; border-radius: 10px; margin: 20px 0; border: 1px solid; display: none; }
        .error-message { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .success-message { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .file-info { font-size: 14px; color: var(--text-secondary); margin-top: 10px; text-align: center; }
        .batch-status { margin-top: 10px; padding: 8px 12px; border-radius: 6px; background-color: #f0f7fa; border: 1px solid #cce5ff; color: #004085; font-size: 0.9em; }
        .batch-status .status-text { font-weight: 500; }
        
        /* Enhanced Card-Based Batch Upload UI */
        .file-status-list {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .file-status-card {
            background: var(--surface);
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        
        .file-status-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #dee2e6;
        }
        
        .file-status-card.success {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #ffffff 100%);
        }
        
        .file-status-card.failed {
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff8f8 0%, #ffffff 100%);
        }

        /* Segmented Control Styling */
        .converter-options {
            margin-bottom: 20px;
            text-align: center;
        }

        .segmented-control {
            display: flex;
            justify-content: center;
            background-color: #eef2ff;
            border-radius: 8px;
            padding: 5px;
            width: fit-content;
            margin: 0 auto 15px auto;
        }

        .segmented-control button {
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            background-color: transparent;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            color: var(--text-secondary);
        }

        .segmented-control button.active {
            background-color: var(--surface);
            color: var(--primary-start);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .segmented-control button:hover:not(.active):not(.disabled) {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .segmented-control button.disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            background-color: var(--surface-3); 
        }
        
        /* Upgrade prompt styles */
        .upgrade-prompt {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
        }
        
        .upgrade-banner {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        
        .upgrade-icon {
            font-size: 16px;
        }
        
        .upgrade-text {
            flex: 1;
            color: #92400e;
            font-weight: 500;
        }
        
        .upgrade-btn {
            background: #f59e0b;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.2s ease;
        }
        
        .upgrade-btn:hover {
            background: #d97706;
            color: white;
        }

        .converter-details {
            margin-top: 10px;
        }

        .static-description {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            min-height: 20px; /* Prevents layout shift */
        }

        .rotating-slogan {
            font-size: 0.9em;
            color: var(--text-secondary);
            min-height: 20px; /* Prevents layout shift */
            transition: opacity 0.5s ease-in-out;
        }

        .file-type-tags {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
        }

        .file-type-tags span {
            background-color: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
            color: #495057;
        }
        
        .file-info-section {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-size {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 120px;
        }
        
        .status-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-start);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .status-text {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .status-text.success {
            color: #28a745;
        }
        
        .status-text.failed {
            color: #dc3545;
        }
        
        .action-buttons-section {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .file-status-card.success .action-buttons-section {
            opacity: 1;
        }
        
        .file-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .copy-file-btn {
            background: #28a745;
            color: white;
        }
        
        .copy-file-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .download-file-btn {
            background: #007bff;
            color: white;
        }
        
        .download-file-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .view-result-btn {
            background: #6f42c1;
            color: white;
        }
        
        .view-result-btn:hover {
            background: #5a32a3;
            transform: translateY(-1px);
        }
        
        /* Dynamic use case text animation */
        .dynamic-use-case-text {
            transition: opacity 0.5s ease-in-out;
            min-height: 1.2em;
            display: block;
        }
        
        .dynamic-use-case-text.fade-out {
            opacity: 0;
        }
        
        .dynamic-use-case-text.fade-in {
            opacity: 1;
        }
        
        /* Clean Two-Pane Workspace Layout */
        .workspace-container {
            width: 100%;
            height: calc(100vh - 80px);
            margin: 0;
            padding: 0;
            display: flex;
        }
        
        .workspace-layout {
            display: flex;
            width: 100%;
            height: 100%;
            gap: 0;
        }
        
        .workspace-pane {
            display: flex;
            flex-direction: column;
            background: var(--surface);
            border: 1px solid #e9ecef;
            overflow: hidden;
        }
        
        #source-document-pane {
            width: 60%;
            min-width: 0;
        }
        
        #intelligence-pane {
            width: 40%;
            min-width: 0;
            border-left: 1px solid #e9ecef;
        }
        
        .pane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .pane-header h3 {
            margin: 0;
            font-size: 1.1em;
        }
        
        /* PDF Viewer Styles */
        .pdf-viewer {
            flex: 1;
            position: relative;
            overflow: auto;
            background: #f8f9fa;
        }
        
        .pdf-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 1.1em;
        }
        
        #pdf-canvas {
            display: none;
            margin: 20px auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        .pdf-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }
        
        .control-btn {
            background: var(--primary-start);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s ease;
        }
        
        .control-btn:hover {
            background: var(--primary-end);
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Tab Controls */
        .tab-controls {
            display: flex;
            gap: 5px;
        }
        
        .tab-btn {
            background: transparent;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .tab-btn.active {
            background: var(--primary-start);
            color: white;
            border-color: var(--primary-start);
        }
        
        .tab-btn:hover:not(.active) {
            background: #f8f9fa;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .content-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 1.1em;
            text-align: center;
        }
        
        .text-output {
            display: none;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .graph-container {
            display: none;
            height: 100%;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .workspace-layout {
                flex-direction: column;
            }
            
            #intelligence-pane {
                width: 100%;
                min-width: auto;
                border-left: none;
                border-top: 1px solid #e9ecef;
            }
        }
        
        @media (max-width: 768px) {
            .workspace-container {
                height: calc(100vh - 120px);
            }
            
            .pane-header {
                padding: 10px 15px;
                flex-direction: column;
                gap: 10px;
            }
            
            .pdf-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .tab-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

    </style>
</head>
<body>

    <header class="header">
        <a href="{{ url_for('main.index') }}" class="brand">
            <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="mdraft Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <span style="display: none; font-size: 1.5em; font-weight: 700; color: var(--text-primary);">mdraft</span>
        </a>
        <nav class="nav-links">
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('main.workspace') }}">Workspace</a>
                <a href="{{ url_for('auth.account') }}">{{ current_user.email }}</a>
                <a href="{{ url_for('auth.logout') }}">Logout</a>
            {% else %}
                <a href="{{ url_for('auth.login') }}">Login</a>
                <a href="{{ url_for('auth.signup') }}" class="btn">Sign Up</a>
            {% endif %}
        </nav>
    </header>

    <main class="workspace-container">
        {% if current_user.is_authenticated %}
            <!-- Document Intelligence Workspace -->
            <div class="workspace-layout">
                <!-- Pane 1: Source Document Viewer -->
                <div id="source-document-pane" class="workspace-pane">
                    <div class="pane-header">
                        <h3>Source Document</h3>
                        <div class="pdf-controls">
                            <button id="prev-page" class="control-btn">‹</button>
                            <span id="page-info">Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
                            <button id="next-page" class="control-btn">›</button>
                            <button id="zoom-in" class="control-btn">+</button>
                            <button id="zoom-out" class="control-btn">−</button>
                            <button id="reset-zoom" class="control-btn">Reset</button>
                        </div>
                    </div>
                    <div id="pdf-container" class="pdf-viewer">
                        <div id="pdf-placeholder" class="pdf-placeholder">
                            <p>Upload a document to view it here</p>
                        </div>
                        <canvas id="pdf-canvas"></canvas>
                    </div>
                </div>

                <!-- Pane 2: Intelligence Pane -->
                <div id="intelligence-pane" class="workspace-pane">
                    <div class="pane-header">
                        <h3>Document Intelligence</h3>
                    </div>
                    
                    <div class="intelligence-content">
                        <div class="export-section" style="padding: 20px; text-align: center;">
                            <button id="exportTextBtn" class="export-btn" style="display: none; background: var(--primary-start); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.2s ease;">
                                Export Clean Text
                            </button>
                        </div>
                        
                        <!-- Executive Summary Section -->
                        <div class="executive-summary-section" style="padding: 20px; border-top: 1px solid #e9ecef;">
                            <h4 style="margin-bottom: 15px; color: var(--text-primary);">Executive Summary</h4>
                            <div style="margin-bottom: 15px;">
                                <label for="summaryLength" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary);">Summary Length:</label>
                                <select id="summaryLength" style="width: 100%; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; background: white; font-size: 14px;">
                                    <option value="sentence">One Sentence</option>
                                    <option value="paragraph">One Paragraph</option>
                                    <option value="bullets">Bullet Points</option>
                                </select>
                            </div>
                            <button id="generateSummaryBtn" class="summary-btn" style="display: none; background: var(--primary-start); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s ease; width: 100%;">
                                Generate Summary
                            </button>
                            <div id="summaryLoading" style="display: none; text-align: center; padding: 15px;">
                                <div class="spinner" style="width: 20px; height: 20px; margin: 0 auto 10px;"></div>
                                <p style="font-size: 14px; color: var(--text-secondary);">Generating summary...</p>
                            </div>
                            <div id="summaryResult" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary);">Summary</h5>
                                <div id="summaryContent" style="font-size: 14px; line-height: 1.6; color: var(--text-primary);"></div>
                            </div>
                        </div>
                        
                        <div class="upload-section">
                            <form id="uploadForm" method="POST" action="{{ url_for('main.convert') }}" enctype="multipart/form-data">
                                <div class="file-input-wrapper">
                                    <div class="file-input">
                                        <input type="file" name="file" id="fileInput" accept=".pdf,.docx,.xlsx,.xls,.pptx,.html,.htm,.csv,.json,.xml,.epub,.gif,.tiff,.tif,.jpg,.jpeg,.png,.bmp,.webp">
                                        <span id="fileLabel"><strong>Click to select a file</strong> or drag and drop</span>
                                    </div>
                                </div>

                                <!-- Converter Options Segmented Control -->
                                <div class="converter-options">
                                    <div class="segmented-control" role="tablist" aria-label="Conversion Options">
                                        <button type="button" id="standard-tab" class="active" role="tab" aria-selected="true" aria-controls="standard-panel">
                                            Standard
                                        </button>
                                        <button type="button" id="pro-tab" role="tab" aria-selected="false" aria-controls="pro-panel">
                                            💎 Pro
                                        </button>
                                    </div>

                                    <div class="converter-details">
                                        <div id="standard-details">
                                            <p class="static-description">Fast conversions for simple text documents.</p>
                                            <p class="rotating-slogan"></p>
                                            <div class="file-type-tags">
                                                <span>DOCX</span><span>XLSX</span><span>PPTX</span><span>CSV</span><span>JSON</span><span>XML</span><span>EPUB</span>
                                            </div>
                                    </div>
                                    <div id="pro-details" style="display: none;">
                                        <p class="static-description">Advanced OCR for complex files, powered by Google Document AI.</p>
                                        <p class="rotating-slogan"></p>
                                        <div class="file-type-tags">
                                            <span>PDF</span><span>JPG</span><span>PNG</span><span>GIF</span><span>TIFF</span><span>BMP</span><span>WebP</span><span>HTML</span>
                                        </div>
                                    </div>
                                </div>

                        <input type="hidden" name="pro_conversion" id="pro_conversion_hidden_input" value="off">
                    </div>

                    <button type="submit" class="convert-btn" id="convertBtn">Convert with mdraft</button>
                </form>
                <div class="file-info" id="fileInfo"></div>
            </section>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loadingText">mdraft is preparing your document...</p>
            </div>

            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>

            <section class="result-section" id="resultSection">
                <div class="result-header">
                    <h2 class="result-title">Converted Markdown</h2>
                    <div class="action-buttons">
                        <button class="action-btn copy-btn" id="copyBtn">📋 Copy</button>
                        <a href="#" class="action-btn download-btn" id="downloadBtn">💾 Download</a>
                        {% if current_user and current_user.has_pro_access %}
                        <a href="#" class="action-btn download-btn pro-download-btn" id="downloadTextBtn" style="display: none;">📄 Download .txt</a>
                        <a href="#" class="action-btn download-btn pro-download-btn" id="downloadJsonBtn" style="display: none;">📊 Download .json</a>
                        {% endif %}
                    </div>
                </div>
                <textarea class="markdown-output" id="markdownOutput" readonly></textarea>
            </section>
        {% else %}
            <!-- Logged-out View -->
            <section class="welcome-message">
                <h1>The Smartest Document to Markdown Converter</h1>
                <p id="dynamic-use-case-text" class="dynamic-use-case-text">Upload PDFs, Word docs, Excel files, PowerPoint, images, and more. Get clean, readable Markdown in seconds.</p>
                <div style="font-size: 0.9em; color: #6b7280; margin: 15px 0;">
                    <strong>Supported formats:</strong> PDF, DOCX, XLSX, PPTX, HTML, CSV, JSON, XML, EPUB, GIF, TIFF, JPG, PNG, BMP, WebP
                </div>
                <a href="{{ url_for('auth.signup') }}" class="welcome-btn">Get Started for Free</a>
            </section>
        {% endif %}
    </main>

    <script>

        
        document.addEventListener('DOMContentLoaded', function() {
            // Only run authenticated user code if elements exist (user is logged in)
            const uploadForm = document.getElementById('uploadForm');
            const convertBtn = document.getElementById('convertBtn');
            const fileInput = document.getElementById('fileInput');
            const fileLabel = document.getElementById('fileLabel');
            const fileInfo = document.getElementById('fileInfo');
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const resultSection = document.getElementById('resultSection');
            const markdownOutput = document.getElementById('markdownOutput');
            const copyBtn = document.getElementById('copyBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            let pollingInterval;
            
            // Only run authenticated user functionality if elements exist
            if (uploadForm && convertBtn && fileInput) {

                // Enhanced Batch upload UI with card-based layout
                const batchStatusContainer = document.createElement('div');
                batchStatusContainer.id = 'batchStatusContainer';
                batchStatusContainer.className = 'file-status-list';
                uploadForm.parentNode.insertBefore(batchStatusContainer, uploadForm.nextSibling);

                // Define isProUser function to check current tab state
                function getIsProUser() {
                    return proBtn.classList.contains('active');
                }

                // --- Segmented Control Logic ---
                const standardBtn = document.getElementById('standard-tab');
                const proBtn = document.getElementById('pro-tab');
                const standardDetails = document.getElementById('standard-details');
                const proDetails = document.getElementById('pro-details');
                const hiddenInput = document.getElementById('pro_conversion_hidden_input');

                // --- Rotating Slogan Logic ---
                const sloganElement = document.querySelector('.rotating-slogan'); // Note: We select the class now
                const standardSlogans = [
                    "Cleaning up a messy Word doc?",
                    "Need to format a DOCX for an AI prompt?",
                    "Quickly structuring your CSV data?",
                    "From XLSX to clean text in seconds."
                ];
                const proSlogans = [
                    "Prepping a scanned PDF for your RAG pipeline?",
                    "Extracting tables from a complex report?",
                    "Turning a scanned contract into usable text?",
                    "Digitizing a document image with OCR?"
                ];

                let currentSlogans = standardSlogans;
                let sloganIndex = 0;
                let sloganInterval;

                function updateSlogan() {
                    const sloganElementStd = standardDetails.querySelector('.rotating-slogan');
                    const sloganElementPro = proDetails.querySelector('.rotating-slogan');

                    sloganElementStd.style.opacity = 0;
                    sloganElementPro.style.opacity = 0;

                    setTimeout(() => {
                        sloganIndex = (sloganIndex + 1) % currentSlogans.length;
                        sloganElementStd.textContent = currentSlogans[sloganIndex];
                        sloganElementPro.textContent = currentSlogans[sloganIndex];
                        sloganElementStd.style.opacity = 1;
                        sloganElementPro.style.opacity = 1;
                    }, 500);
                }

                function startSloganRotation() {
                    stopSloganRotation(); // Clear any existing interval
                    // Set initial text immediately
                    const sloganElementStd = standardDetails.querySelector('.rotating-slogan');
                    const sloganElementPro = proDetails.querySelector('.rotating-slogan');
                    sloganIndex = 0;
                    sloganElementStd.textContent = currentSlogans[sloganIndex];
                    sloganElementPro.textContent = currentSlogans[sloganIndex];
                    sloganElementStd.style.opacity = 1;
                    sloganElementPro.style.opacity = 1;
                    
                    sloganInterval = setInterval(updateSlogan, 3000);
                }

                function stopSloganRotation() {
                    clearInterval(sloganInterval);
                }

                // --- Event Listeners ---
                standardBtn.addEventListener('click', () => {
                    if (standardBtn.classList.contains('active')) return; // Do nothing if already active
                    standardBtn.classList.add('active');
                    proBtn.classList.remove('active');
                    standardDetails.style.display = 'block';
                    proDetails.style.display = 'none';
                    hiddenInput.value = 'off';
                    currentSlogans = standardSlogans;
                    startSloganRotation();
                });

                proBtn.addEventListener('click', () => {
                    // Prevent clicking if disabled
                    if (proBtn.classList.contains('disabled')) return;
                    
                    if (proBtn.classList.contains('active')) return; // Do nothing if already active
                    proBtn.classList.add('active');
                    standardBtn.classList.remove('active');
                    standardDetails.style.display = 'none';
                    proDetails.style.display = 'block';
                    hiddenInput.value = 'on';
                    currentSlogans = proSlogans;
                    startSloganRotation();
                });

                // Initialize slogan rotation
                startSloganRotation();

                // --- File Input Logic ---
                fileInput.addEventListener('change', (e) => {
                    const isProUser = getIsProUser();
                    
                    if (isProUser && fileInput.files.length > 1) {
                        fileLabel.innerHTML = `<strong>Selected:</strong> ${fileInput.files.length} files`;
                        let info = '';
                        Array.from(fileInput.files).forEach(f => {
                            info += `<div><strong>${f.name}</strong> - ${(f.size / 1024 / 1024).toFixed(2)} MB</div>`;
                        });
                        fileInfo.innerHTML = info;
                    } else {
                        const file = e.target.files[0];
                        if (file) {
                            fileLabel.innerHTML = `<strong>Selected:</strong> ${file.name}`;
                            fileInfo.innerHTML = `<strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB`;
                        } else {
                            fileLabel.innerHTML = '<strong>Click to select a file</strong> or drag and drop';
                            fileInfo.innerHTML = '';
                        }
                    }
                });

                // --- Form Submission Logic ---
                uploadForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    hideMessages();
                    resultSection.style.display = 'none';
                    convertBtn.disabled = true;
                    convertBtn.textContent = 'CONVERTING...';
                    loading.style.display = 'block';
                    
                    // Get current Pro user state
                    const isProUser = getIsProUser();
                    loadingText.textContent = isProUser && fileInput.files.length > 1 ? 'Uploading and starting batch conversion...' : 'Uploading and starting conversion...';
                    batchStatusContainer.innerHTML = '';

                    const files = isProUser ? Array.from(fileInput.files) : [fileInput.files[0]];
                    if (!files.length || !files[0]) {
                        showError('Please select a file first.');
                        convertBtn.disabled = false;
                        convertBtn.textContent = 'Convert with mdraft';
                        loading.style.display = 'none';
                        return;
                    }

                    // Handle single file upload (non-Pro or single file selected)
                    if (!isProUser || files.length === 1) {
                        const file = files[0];
                        const formData = new FormData(uploadForm);
                        formData.set('file', file);

                        try {
                            const startResponse = await fetch("{{ url_for('main.convert') }}", { method: 'POST', body: formData });
                            
                            if (!startResponse.ok) {
                                const errorData = await startResponse.json();
                                
                                // Handle upgrade required responses
                                if (startResponse.status === 403 && errorData.upgrade_required) {
                                    showUpgradePrompt(errorData.error, errorData.upgrade_url);
                                    resetUI();
                                    return;
                                }
                                
                                throw new Error(errorData.error || `HTTP error! status: ${startResponse.status}`);
                            }

                            const startData = await startResponse.json();
                            if (startResponse.status === 202) {
                                loadingText.textContent = 'File conversion in progress...';
                                // Use job_id to construct the status URL
                                const statusUrl = `/status/${startData.job_id}`;
                                pollForTaskStatus(statusUrl);
                                
                                // Store job ID for workspace integration
                                window.currentJobId = startData.job_id;
                            } else {
                                throw new Error(startData.error || 'Could not start conversion job.');
                            }
                        } catch (error) {
                            showError(`Error: ${error.message}`);
                            resetUI();
                        }
                    } else {
                        // Handle batch upload for Pro users with multiple files
                        const statusTrackers = [];
                        
                        // Create status cards for each file
                        for (const file of files) {
                            const fileCard = createFileStatusCard(file);
                            batchStatusContainer.appendChild(fileCard);
                            statusTrackers.push({ file, card: fileCard });
                        }

                        // Start all uploads in parallel
                        await Promise.all(statusTrackers.map(async ({ file, card }) => {
                            const formData = new FormData(uploadForm);
                            formData.set('file', file);
                            try {
                                const startResponse = await fetch("{{ url_for('main.convert') }}", { method: 'POST', body: formData });
                                if (!startResponse.ok) {
                                    const errorData = await startResponse.json();
                                    throw new Error(errorData.error || `HTTP error! status: ${startResponse.status}`);
                                }
                                const startData = await startResponse.json();
                                
                                // Update card to show processing state
                                updateCardStatus(card, 'processing', 'Processing...');
                                
                                // Store job ID in card for polling
                                card.dataset.jobId = startData.job_id;
                                
                                // Start polling for this specific card
                                pollBatchStatus(startData.job_id, card, file.name);
                            } catch (err) {
                                updateCardStatus(card, 'failed', `Error: ${err.message}`);
                            }
                        }));

                        convertBtn.disabled = false;
                        convertBtn.textContent = 'Convert with mdraft';
                        loading.style.display = 'none';
                    }
                });

                // Helper function to create a file status card
                function createFileStatusCard(file) {
                    const card = document.createElement('div');
                    card.className = 'file-status-card';
                    card.dataset.fileName = file.name;
                    
                    const fileSize = (file.size / 1024 / 1024).toFixed(2);
                    
                    card.innerHTML = `
                        <div class="file-info-section">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${fileSize} MB</div>
                        </div>
                        <div class="status-indicator">
                            <div class="status-spinner"></div>
                            <div class="status-text">Uploading...</div>
                        </div>
                        <div class="action-buttons-section">
                            <button class="file-action-btn copy-file-btn" data-filename="${file.name}">
                                📋 Copy
                            </button>
                            <a class="file-action-btn download-file-btn" href="#" download>
                                💾 Download
                            </a>
                            <button class="file-action-btn view-result-btn" data-filename="${file.name}">
                                👁️ View
                            </button>
                        </div>
                    `;
                    
                    // Add event listeners properly
                    const copyBtn = card.querySelector('.copy-file-btn');
                    const viewBtn = card.querySelector('.view-result-btn');
                    
                    copyBtn.addEventListener('click', () => copyFileResult(file.name));
                    viewBtn.addEventListener('click', () => viewFileResult(file.name));
                    
                    return card;
                }

                function updateCardStatus(card, status, message) {
                    const statusText = card.querySelector('.status-text');
                    const statusSpinner = card.querySelector('.status-spinner');
                    
                    statusText.textContent = message;
                    
                    if (status === 'processing') {
                        statusSpinner.style.display = 'block';
                        card.classList.add('processing');
                    } else if (status === 'completed') {
                        statusSpinner.style.display = 'none';
                        card.classList.add('completed');
                    } else if (status === 'failed') {
                        statusSpinner.style.display = 'none';
                        card.classList.add('failed');
                    }
                }

                function pollBatchStatus(jobId, card, fileName) {
                    const pollInterval = setInterval(async () => {
                        try {
                            const response = await fetch(`/status/${jobId}`);
                            const data = await response.json();
                            
                            if (data.status === 'completed') {
                                clearInterval(pollInterval);
                                updateCardStatus(card, 'completed', 'Conversion completed');
                                
                                // Fetch result
                                const resultResponse = await fetch(`/result/${jobId}`);
                                const resultData = await resultResponse.json();
                                
                                if (resultData.markdown) {
                                    // Store result for later access
                                    card.dataset.markdown = resultData.markdown;
                                    card.dataset.filename = resultData.filename;
                                }
                            } else if (data.status === 'failed') {
                                clearInterval(pollInterval);
                                updateCardStatus(card, 'failed', `Failed: ${data.error || 'Unknown error'}`);
                            } else {
                                updateCardStatus(card, 'processing', 'Processing...');
                            }
                        } catch (error) {
                            clearInterval(pollInterval);
                            updateCardStatus(card, 'failed', 'Network error');
                        }
                    }, 2000);
                }

                function copyFileResult(fileName) {
                    const card = document.querySelector(`[data-file-name="${fileName}"]`);
                    if (card && card.dataset.markdown) {
                        navigator.clipboard.writeText(card.dataset.markdown).then(() => {
                            const copyBtn = card.querySelector('.copy-file-btn');
                            const originalText = copyBtn.textContent;
                            copyBtn.textContent = '✅ Copied!';
                            setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
                        });
                    }
                }

                function viewFileResult(fileName) {
                    const card = document.querySelector(`[data-file-name="${fileName}"]`);
                    if (card && card.dataset.markdown) {
                        markdownOutput.value = card.dataset.markdown;
                        resultSection.style.display = 'block';
                        showSuccess(`Showing result for "${card.dataset.filename}"`);
                    }
                }

                function pollForTaskStatus(statusUrl) {
                    // Store job ID for Pro downloads
                    const jobId = statusUrl.split('/').pop();
                    window.currentJobId = jobId;
                    
                    pollingInterval = setInterval(async () => {
                        try {
                            const statusResponse = await fetch(statusUrl);
                            const data = await statusResponse.json();

                            if (data.status === 'completed') {
                                clearInterval(pollingInterval);
                                // Fetch the full result from the separate result endpoint
                                const resultResponse = await fetch(`/result/${jobId}`);
                                const resultData = await resultResponse.json();
                                
                                if (resultData.markdown) {
                                    handleSuccess(resultData);
                                } else {
                                    handleFailure('No result data available');
                                }
                            } else if (data.status === 'failed') {
                                clearInterval(pollingInterval);
                                handleFailure(data.error);
                            } else {
                                loadingText.textContent = data.status || 'Conversion in progress...';
                            }
                        } catch (error) {
                            clearInterval(pollingInterval);
                            showError('Network error while checking status.');
                            resetUI();
                        }
                    }, 2500);
                }

                function handleSuccess(result) {
                    // Update workspace with results
                    updateWorkspaceWithResults(result);
                    
                    // Also update the traditional result section for backward compatibility
                    markdownOutput.value = result.markdown;
                    resultSection.style.display = 'block';
                    showSuccess(`Successfully converted "${result.filename}"!`);
                    
                    const blob = new Blob([result.markdown], { type: 'text/plain' });
                    downloadBtn.href = URL.createObjectURL(blob);
                    downloadBtn.download = 'mdraft_output.md';
                    downloadBtn.style.display = 'inline-block';

                    // Show export button
                    const exportTextBtn = document.getElementById('exportTextBtn');
                    if (exportTextBtn) {
                        exportTextBtn.style.display = 'inline-block';
                    }

                    // Show generate summary button
                    const generateSummaryBtn = document.getElementById('generateSummaryBtn');
                    if (generateSummaryBtn) {
                        generateSummaryBtn.style.display = 'block';
                    }

                    // Show Pro download buttons if user has Pro access
                    const downloadTextBtn = document.getElementById('downloadTextBtn');
                    const downloadJsonBtn = document.getElementById('downloadJsonBtn');
                    if (downloadTextBtn && downloadJsonBtn) {
                        downloadTextBtn.style.display = 'inline-block';
                        downloadJsonBtn.style.display = 'inline-block';
                        
                        // Get job ID from the current polling URL or result
                        const jobId = getCurrentJobId();
                        if (jobId) {
                            downloadTextBtn.href = `/result/${jobId}/text`;
                            downloadJsonBtn.href = `/result/${jobId}/json`;
                            downloadTextBtn.download = `${result.filename || 'output'}.txt`;
                            downloadJsonBtn.download = `${result.filename || 'output'}.json`;
                        }
                    }

                    resetUI();
                }
                
                function updateWorkspaceWithResults(result) {
                    // Update clean text tab
                    const cleanTextOutput = document.getElementById('clean-text-output');
                    const cleanTextPlaceholder = document.getElementById('clean-text-placeholder');
                    
                    if (cleanTextOutput && cleanTextPlaceholder) {
                        cleanTextOutput.textContent = result.markdown;
                        cleanTextOutput.style.display = 'block';
                        cleanTextPlaceholder.style.display = 'none';
                    }
                    
                    // Try to render PDF if it's a PDF file
                    if (result.filename && result.filename.toLowerCase().endsWith('.pdf')) {
                        // For now, we'll use a placeholder URL - in production this would be the actual PDF URL
                        const pdfUrl = `/result/${window.currentJobId}/pdf`;
                        renderPdf(pdfUrl).catch(error => {
                            console.log('PDF rendering not available yet:', error);
                        });
                    }
                    
                    // Load knowledge graph data
                    loadKnowledgeGraphData();
                }
                
                function loadKnowledgeGraphData() {
                    const jobId = getCurrentJobId();
                    if (!jobId) return;
                    
                    fetch(`/result/${jobId}/graph`)
                        .then(response => response.json())
                        .then(data => {
                            const graphContainer = document.getElementById('knowledge-graph-container');
                            const graphPlaceholder = document.getElementById('knowledge-graph-placeholder');
                            
                            if (graphContainer && graphPlaceholder) {
                                if (data.knowledge_graph && data.knowledge_graph.nodes) {
                                    renderKnowledgeGraph(data.knowledge_graph);
                                    graphContainer.style.display = 'block';
                                    graphPlaceholder.style.display = 'none';
                                } else {
                                    graphPlaceholder.innerHTML = '<p>Knowledge graph data not available yet.</p>';
                                }
                            }
                        })
                        .catch(error => {
                            console.log('Knowledge graph not available yet:', error);
                            const graphPlaceholder = document.getElementById('knowledge-graph-placeholder');
                            if (graphPlaceholder) {
                                graphPlaceholder.innerHTML = '<p>Knowledge graph will be available shortly.</p>';
                            }
                        });
                }
                
                function renderKnowledgeGraph(graphData) {
                    const graphContainer = document.getElementById('knowledge-graph-container');
                    if (!graphContainer) return;
                    
                    // Clear container
                    graphContainer.innerHTML = '';
                    
                    // Load Sigma.js
                    loadSigmaJS().then(() => {
                        try {
                            // Create graph data for Sigma.js
                            const graph = {
                                nodes: graphData.nodes.map(node => ({
                                    id: node.id,
                                    label: node.label,
                                    x: Math.random() * 1000,
                                    y: Math.random() * 1000,
                                    size: 8,
                                    color: getNodeColor(node.type)
                                })),
                                edges: graphData.edges.map(edge => ({
                                    id: `${edge.source}-${edge.target}`,
                                    source: edge.source,
                                    target: edge.target,
                                    label: edge.label,
                                    size: 2,
                                    color: '#666'
                                }))
                            };
                            
                            // Initialize Sigma.js
                            const sigma = new sigma({
                                graph: graph,
                                container: graphContainer,
                                settings: {
                                    nodeLabelSize: 'proportional',
                                    edgeLabelSize: 'proportional',
                                    minNodeSize: 4,
                                    maxNodeSize: 12,
                                    minEdgeSize: 1,
                                    maxEdgeSize: 4,
                                    enableEdgeHovering: true,
                                    enableEdgeLabels: true,
                                    enableNodeHovering: true,
                                    enableNodeLabels: true
                                }
                            });
                            
                            // Add click event for bidirectional linking
                            sigma.on('clickNode', function(event) {
                                const node = event.data.node;
                                console.log('Node clicked:', node.label);
                                
                                // Search for this text in the PDF
                                searchTextInPDF(node.label);
                                
                                // Highlight the node in the graph
                                highlightNodeInGraph(node.id);
                            });
                            
                            // Add text selection event from PDF
                            document.addEventListener('pdfTextSelected', function(event) {
                                const selectedText = event.detail.text;
                                searchNodeInGraph(selectedText);
                            });
                            
                            console.log('Knowledge graph rendered with Sigma.js');
                            
                        } catch (error) {
                            console.error('Error rendering knowledge graph:', error);
                            graphContainer.innerHTML = `
                                <div style="padding: 20px; text-align: center;">
                                    <h4>Knowledge Graph</h4>
                                    <p>Nodes: ${graphData.nodes.length}</p>
                                    <p>Edges: ${graphData.edges.length}</p>
                                    <p>Error rendering graph: ${error.message}</p>
                                </div>
                            `;
                        }
                    }).catch(error => {
                        console.error('Failed to load Sigma.js:', error);
                        graphContainer.innerHTML = `
                            <div style="padding: 20px; text-align: center;">
                                <h4>Knowledge Graph</h4>
                                <p>Nodes: ${graphData.nodes.length}</p>
                                <p>Edges: ${graphData.edges.length}</p>
                                <p>Sigma.js not available</p>
                            </div>
                        `;
                    });
                }
                
                function loadSigmaJS() {
                    return new Promise((resolve, reject) => {
                        if (typeof sigma !== 'undefined') {
                            resolve(sigma);
                            return;
                        }
                        
                        // Try multiple CDN sources
                        const sources = [
                            'https://cdnjs.cloudflare.com/ajax/libs/sigma.js/2.4.0/sigma.min.js',
                            'https://unpkg.com/sigma@2.4.0/dist/sigma.min.js',
                            'https://cdn.jsdelivr.net/npm/sigma@2.4.0/dist/sigma.min.js'
                        ];
                        
                        function trySource(index) {
                            if (index >= sources.length) {
                                reject(new Error('Failed to load Sigma.js from all sources'));
                                return;
                            }
                            
                            const script = document.createElement('script');
                            script.src = sources[index];
                            script.onload = () => {
                                                            console.log(`Sigma.js loaded from source ${index + 1}`);
                            resolve(sigma);
                            };
                            script.onerror = () => {
                                console.log(`Sigma.js failed to load from source ${index + 1}`);
                                trySource(index + 1);
                            };
                            document.head.appendChild(script);
                        }
                        
                        trySource(0);
                    });
                }
                
                function getNodeColor(type) {
                    const colors = {
                        'PERSON': '#4CAF50',
                        'ORGANIZATION': '#2196F3',
                        'CONTRACT': '#FF9800',
                        'AMOUNT': '#9C27B0',
                        'DATE': '#607D8B',
                        'LOCATION': '#795548',
                        'CLAUSE': '#E91E63',
                        'TERM': '#00BCD4',
                        'COLUMN': '#FF5722',
                        'NUMBER': '#8BC34A',
                        'DOCUMENT': '#9E9E9E'
                    };
                    return colors[type] || '#666';
                }
                
                function searchTextInPDF(text) {
                    // This would integrate with PDF.js to search and highlight text
                    console.log('Searching for text in PDF:', text);
                    // TODO: Implement PDF text search and highlighting
                }
                
                function highlightNodeInGraph(nodeId) {
                    // This would highlight the node in the Sigma.js graph
                    console.log('Highlighting node in graph:', nodeId);
                    // TODO: Implement node highlighting
                }
                
                function searchNodeInGraph(text) {
                    // This would search for a node with matching text
                    console.log('Searching for node in graph:', text);
                    // TODO: Implement node search
                }

                function getCurrentJobId() {
                    // Try to get job ID from the current polling URL
                    if (window.currentJobId) {
                        return window.currentJobId;
                    }
                    return null;
                }

                function handleFailure(errorMsg) {
                    showError(`Conversion Failed: ${errorMsg}`);
                    resetUI();
                }

                function resetUI() {
                    loading.style.display = 'none';
                    convertBtn.disabled = false;
                    convertBtn.textContent = 'Convert with mdraft';
                    
                    // Hide Pro download buttons
                    const downloadTextBtn = document.getElementById('downloadTextBtn');
                    const downloadJsonBtn = document.getElementById('downloadJsonBtn');
                    if (downloadTextBtn) downloadTextBtn.style.display = 'none';
                    if (downloadJsonBtn) downloadJsonBtn.style.display = 'none';
                }

                function getJobIdFromUrl() {
                    // Extract job ID from current URL or polling URL
                    const urlParams = new URLSearchParams(window.location.search);
                    return urlParams.get('job_id') || null;
                }

                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(markdownOutput.value).then(() => {
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = '✅ Copied!';
                        setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
                    }).catch(() => {
                        showError('Could not copy to clipboard.');
                    });
                });

                function showError(message) {
                    errorMessage.textContent = message;
                    errorMessage.style.display = 'block';
                    successMessage.style.display = 'none';
                }

                function showSuccess(message) {
                    successMessage.textContent = message;
                    successMessage.style.display = 'block';
                    errorMessage.style.display = 'none';
                }
                
                function showUpgradePrompt(message, upgradeUrl) {
                    // Create a modal-like upgrade prompt
                    const upgradeModal = document.createElement('div');
                    upgradeModal.className = 'upgrade-modal';
                    upgradeModal.innerHTML = `
                        <div class="upgrade-modal-content">
                            <div class="upgrade-modal-header">
                                <span class="upgrade-modal-icon">🔒</span>
                                <h3>Upgrade Required</h3>
                            </div>
                            <div class="upgrade-modal-body">
                                <p>${message}</p>
                                <div class="upgrade-modal-actions">
                                    <a href="${upgradeUrl}" class="upgrade-modal-btn primary">Upgrade Now</a>
                                    <button class="upgrade-modal-btn secondary" onclick="this.parentElement.parentElement.parentElement.parentElement.remove()">Cancel</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(upgradeModal);
                }

                function hideMessages() {
                    errorMessage.style.display = 'none';
                    successMessage.style.display = 'none';
                }
                

                
                // Main PDF rendering function
                async function renderPdf(url) {
                    try {
                        console.log('Rendering PDF from URL:', url);
                        
                        // First, test if the URL is accessible with credentials
                        const response = await fetch(url, {
                            credentials: 'include' // Include cookies for session authentication
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        console.log('PDF URL is accessible, loading with PDF.js...');
                        
                        const loadingTask = pdfjsLib.getDocument(url);
                        pdfDoc = await loadingTask.promise;
                        
                        console.log('PDF loaded successfully, pages:', pdfDoc.numPages);
                        
                        document.getElementById('total-pages').textContent = pdfDoc.numPages;
                        document.getElementById('pdf-placeholder').style.display = 'none';
                        document.getElementById('pdf-canvas').style.display = 'block';
                        
                        pageNum = 1;
                        renderPage(pageNum);
                        
                        // Enable controls
                        document.getElementById('prev-page').disabled = false;
                        document.getElementById('next-page').disabled = false;
                        document.getElementById('zoom-in').disabled = false;
                        document.getElementById('zoom-out').disabled = false;
                        document.getElementById('reset-zoom').disabled = false;
                        
                        console.log('PDF rendered successfully');
                        
                    } catch (error) {
                        console.error('Error rendering PDF:', error);
                        document.getElementById('pdf-placeholder').innerHTML = `<p>Error loading PDF: ${error.message}</p>`;
                    }
                }
                
                // Setup PDF text selection for bidirectional linking
                function setupPDFTextSelection() {
                    const canvas = document.getElementById('pdf-canvas');
                    if (!canvas) return;
                    
                    let isSelecting = false;
                    let startX, startY, endX, endY;
                    
                    canvas.addEventListener('mousedown', function(e) {
                        isSelecting = true;
                        const rect = canvas.getBoundingClientRect();
                        startX = e.clientX - rect.left;
                        startY = e.clientY - rect.top;
                    });
                    
                    canvas.addEventListener('mousemove', function(e) {
                        if (!isSelecting) return;
                        
                        const rect = canvas.getBoundingClientRect();
                        endX = e.clientX - rect.left;
                        endY = e.clientY - rect.top;
                        
                        // Draw selection rectangle
                        drawSelectionRectangle();
                    });
                    
                    canvas.addEventListener('mouseup', function(e) {
                        if (!isSelecting) return;
                        
                        isSelecting = false;
                        
                        // Get selected text (simplified - in real implementation, this would use PDF.js text layer)
                        const selectedText = getSelectedTextFromPDF();
                        if (selectedText) {
                            // Dispatch custom event for knowledge graph
                            const event = new CustomEvent('pdfTextSelected', {
                                detail: { text: selectedText }
                            });
                            document.dispatchEvent(event);
                        }
                        
                        // Clear selection rectangle
                        clearSelectionRectangle();
                    });
                }
                
                function drawSelectionRectangle() {
                    // This would draw a selection rectangle on the canvas
                    // For now, just log the selection area
                    console.log('Selection area:', { startX, startY, endX, endY });
                }
                
                function clearSelectionRectangle() {
                    // Clear the selection rectangle
                    console.log('Clearing selection rectangle');
                }
                
                function getSelectedTextFromPDF() {
                    // This would extract text from the selected area in the PDF
                    // For now, return a placeholder
                    return 'Sample selected text';
                }
                

                
                // --- PDF Control Functions ---
                let pdfDoc = null;
                let pageNum = 1;
                let pageRendering = false;
                let pageNumPending = null;
                let scale = 1.5;
                
                function renderPage(num) {
                    pageRendering = true;
                    
                    pdfDoc.getPage(num).then(function(page) {
                        const viewport = page.getViewport({scale: scale});
                        const canvas = document.getElementById('pdf-canvas');
                        const context = canvas.getContext('2d');
                        
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        
                        const renderContext = {
                            canvasContext: context,
                            viewport: viewport
                        };
                        
                        const renderTask = page.render(renderContext);
                        
                        renderTask.promise.then(function() {
                            pageRendering = false;
                            if (pageNumPending !== null) {
                                renderPage(pageNumPending);
                                pageNumPending = null;
                            }
                        });
                    });
                    
                    document.getElementById('current-page').textContent = num;
                }
                
                function queueRenderPage(num) {
                    if (pageRendering) {
                        pageNumPending = num;
                    } else {
                        renderPage(num);
                    }
                }
                
                function onPrevPage() {
                    if (pageNum <= 1) {
                        return;
                    }
                    pageNum--;
                    queueRenderPage(pageNum);
                }
                
                function onNextPage() {
                    if (pageNum >= pdfDoc.numPages) {
                        return;
                    }
                    pageNum++;
                    queueRenderPage(pageNum);
                }
                
                function zoomIn() {
                    scale *= 1.2;
                    queueRenderPage(pageNum);
                }
                
                function zoomOut() {
                    scale *= 0.8;
                    queueRenderPage(pageNum);
                }
                
                function resetZoom() {
                    scale = 1.5;
                    queueRenderPage(pageNum);
                }
                
                // --- PDF Controls Event Listeners ---
                function initializePDFControls() {
                    document.getElementById('prev-page').addEventListener('click', onPrevPage);
                    document.getElementById('next-page').addEventListener('click', onNextPage);
                    document.getElementById('zoom-in').addEventListener('click', zoomIn);
                    document.getElementById('zoom-out').addEventListener('click', zoomOut);
                    document.getElementById('reset-zoom').addEventListener('click', resetZoom);
                    
                    // Initially disable controls
                    document.getElementById('prev-page').disabled = true;
                    document.getElementById('next-page').disabled = true;
                    document.getElementById('zoom-in').disabled = true;
                    document.getElementById('zoom-out').disabled = true;
                    document.getElementById('reset-zoom').disabled = true;
                }
                
                // --- Workspace Initialization ---
                function initializeWorkspace() {
                    initializePDFControls();
                }
                
                // Export functionality
                const exportTextBtn = document.getElementById('exportTextBtn');
                if (exportTextBtn) {
                    exportTextBtn.addEventListener('click', () => {
                        const jobId = getCurrentJobId();
                        if (jobId) {
                            window.open(`/result/${jobId}/export/text`, '_blank');
                        }
                    });
                }
                
                // Executive Summary functionality
                const generateSummaryBtn = document.getElementById('generateSummaryBtn');
                const summaryLength = document.getElementById('summaryLength');
                const summaryLoading = document.getElementById('summaryLoading');
                const summaryResult = document.getElementById('summaryResult');
                const summaryContent = document.getElementById('summaryContent');
                
                if (generateSummaryBtn) {
                    generateSummaryBtn.addEventListener('click', async () => {
                        const jobId = getCurrentJobId();
                        if (!jobId) {
                            showError('No conversion available for summarization');
                            return;
                        }
                        
                        const length = summaryLength.value;
                        
                        // Show loading state
                        generateSummaryBtn.style.display = 'none';
                        summaryLoading.style.display = 'block';
                        summaryResult.style.display = 'none';
                        
                        try {
                            const response = await fetch(`/api/v1/conversion/${jobId}/summarize`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-API-Key': 'test-api-key' // For development
                                },
                                body: JSON.stringify({ length: length })
                            });
                            
                            const data = await response.json();
                            
                            if (response.ok) {
                                // Display summary
                                summaryContent.textContent = data.summary;
                                summaryResult.style.display = 'block';
                                showSuccess('Summary generated successfully!');
                            } else {
                                showError(`Failed to generate summary: ${data.error}`);
                            }
                        } catch (error) {
                            showError(`Error generating summary: ${error.message}`);
                        } finally {
                            // Hide loading state
                            summaryLoading.style.display = 'none';
                            generateSummaryBtn.style.display = 'block';
                        }
                    });
                }
                
                // Initialize workspace when DOM is loaded
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initializeWorkspace);
                } else {
                    initializeWorkspace();
                }
            }
        });
    </script>
</body>
</html>